router.post('/generate', async (req: Request, res: Response) => {
  const startTime = Date.now();
  
  try {
    const requestData: FortuneRequest = req.body;
    
    // éªŒè¯è¾“å…¥
    if (!requestData.question || !requestData.type) {
      return res.status(400).json({
        success: false,
        error: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šquestion å’Œ type',
        timestamp: new Date().toISOString()
      });
    }

    console.log('ğŸ¯ æ”¶åˆ°å…«å­—MCP + ModelScope AIåˆ†æè¯·æ±‚:', { 
      question: requestData.question, 
      type: requestData.type,
      hasBirthInfo: !!requestData.birthInfo
    });

    let baziData = null;
    
    // å¦‚æœæ˜¯å…«å­—ç±»å‹çš„åˆ†æï¼Œå…ˆé€šè¿‡@cantian-ai/Bazi-MCPè·å–å…«å­—æ•°æ®
    if (requestData.type === 'bazi' || requestData.birthInfo) {
      try {
        console.log('ğŸ”® è°ƒç”¨@cantian-ai/Bazi-MCPæœåŠ¡ï¼ˆms-agenté£æ ¼ï¼‰...');
        
        // å‡†å¤‡å…«å­—è®¡ç®—å‚æ•°
        const birthData = requestData.birthInfo ? {
          year: requestData.birthInfo.year,
          month: requestData.birthInfo.month,
          day: requestData.birthInfo.day,
          hour: requestData.birthInfo.hour,
          minute: requestData.birthInfo.minute,
          gender: 'male',
          timezone: 'Asia/Shanghai'
        } : extractBirthDataFromRequest(requestData);
        
        if (birthData) {
          // è°ƒç”¨åŸºäºms-agenté£æ ¼çš„å…«å­—MCPæœåŠ¡
          const baziResult = await mcpService.calculateBazi(birthData);
          
          if (baziResult.success) {
            baziData = baziResult.data;
            console.log('âœ… @cantian-ai/Bazi-MCPè®¡ç®—æˆåŠŸ:', {
              hasBazi: !!baziData?.bazi,
              hasWuxing: !!baziData?.wuxing,
              dayMaster: baziData?.dayMasterStrength?.dayMaster
            });
          } else {
            console.warn('âš ï¸ @cantian-ai/Bazi-MCPè®¡ç®—å¤±è´¥:', baziResult.error);
          }
        } else {
          console.log('âš ï¸ æœªæä¾›æœ‰æ•ˆçš„å‡ºç”Ÿæ•°æ®ï¼Œè·³è¿‡å…«å­—MCPè®¡ç®—');
        }
      } catch (error: any) {
        console.error('âŒ @cantian-ai/Bazi-MCPæœåŠ¡è°ƒç”¨å¤±è´¥:', error);
        // ç»§ç»­ä½¿ç”¨çº¯AIåˆ†æ
      }
    }

    // åˆå§‹åŒ–çœŸæ­£çš„ModelScopeæœåŠ¡
    const realModelService = new RealModelScopeOnlineService({
      apiKey: process.env.MODELSCOPE_API_KEY || '',
      modelId: process.env.MODELSCOPE_MODEL || 'ZhipuAI/GLM-4.6',
      baseUrl: process.env.MODELSCOPE_BASE_URL || 'https://api-inference.modelscope.cn/v1'
    });

    // æ„å»ºåŒ…å«å…«å­—æ•°æ®çš„å¢å¼ºæç¤ºè¯
    let enhancedQuestion = requestData.question;
    if (baziData) {
      enhancedQuestion = `${requestData.question}\n\n=== åŸºäºä»¥ä¸‹å…«å­—ä¸“ä¸šåˆ†æ ===\nå…«å­—ï¼š${baziData.bazi.year.stem}${baziData.bazi.year.branch} ${baziData.bazi.month.stem}${baziData.bazi.month.branch} ${baziData.bazi.day.stem}${baziData.bazi.day.branch} ${baziData.bazi.hour.stem}${baziData.bazi.hour.branch}\næ—¥ä¸»ï¼š${baziData.dayMasterStrength.dayMaster}ï¼ˆ${baziData.dayMasterStrength.strength}ï¼‰\nå–œç”¨ç¥ï¼š${baziData.favorableElements.favorable?.join('ã€') || 'æœªç¡®å®š'}\näº”è¡Œï¼š${JSON.stringify(baziData.wuxing.elements)}\n\nè¯·åŸºäºä»¥ä¸Šå…«å­—æ•°æ®è¿›è¡Œä¸“ä¸šåˆ†æã€‚`;
    }

    // ä½¿ç”¨çœŸæ­£çš„ModelScope AIç”Ÿæˆç®—å‘½ç»“æœ
    const fortuneResult = await realModelService.generateFortune(
      enhancedQuestion,
      requestData.context
    );

    console.log('âœ… å…«å­—MCP + ModelScope AIåˆ†æå®Œæˆ:', {
      success: fortuneResult.success,
      source: fortuneResult.source,
      hasBaziData: !!baziData,
      mcpProtocol: 'bazi-mcp-ms-agent-style'
    });

    const response: FortuneResponse = {
      id: uuidv4(),
      question: requestData.question,
      type: requestData.type,
      result: {
        ...fortuneResult,
        baziMcpData: baziData
      },
      timestamp: new Date().toISOString(),
      processingTime: Date.now() - startTime
    };

    res.json(response);
    
  } catch (error: any) {
    console.error('âŒ å…«å­—MCP + ModelScope AIåˆ†æå¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ç®—å‘½æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•',
      timestamp: new Date().toISOString()
    });
  }
router.post('/chat', async (req: Request, res: Response) => {
  const startTime = Date.now();
  
  try {
    const requestData: { 
      question: string; 
      type?: string; 
      context?: string;
      birthInfo?: any;
    } = req.body;
    
    if (!requestData.question) {
      return res.status(400).json({
        success: false,
        error: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šquestion',
        timestamp: new Date().toISOString()
      });
    }
    
    console.log('ğŸ’¬ æ”¶åˆ°å…«å­—MCP + ModelScope AIèŠå¤©è¯·æ±‚:', { 
      question: requestData.question,
      type: requestData.type,
      context: requestData.context?.substring(0, 100) + '...',
      hasBirthInfo: !!requestData.birthInfo,
      body: req.body
    });
    
    let baziData = null;
    
    let analysisType = 'general'; // é»˜è®¤ä¸ºæ™®é€šåˆ†æ
    
    // å¦‚æœç”¨æˆ·æä¾›äº†ç”Ÿè¾°å…«å­—ï¼Œå…ˆé€šè¿‡@cantian-ai/Bazi-MCPè·å–åˆ†æ
    if (requestData.birthInfo || requestData.type === 'bazi' || 
        extractBirthDataFromContext(requestData.context) || extractBirthDataFromQuestion(requestData.question)) {
      try {
        console.log('ğŸ”® è°ƒç”¨@cantian-ai/Bazi-MCPæœåŠ¡ï¼ˆèŠå¤©æ¨¡å¼ï¼‰...');
        
        // æå–æˆ–ä½¿ç”¨æä¾›çš„ç”Ÿè¾°æ•°æ®
        const birthData = requestData.birthInfo || 
                         extractBirthDataFromContext(requestData.context) ||
                         extractBirthDataFromQuestion(requestData.question);
        
        if (birthData) {
          const baziResult = await mcpService.calculateBazi(birthData);
          
          if (baziResult.success) {
            baziData = baziResult.data;
            analysisType = 'bazi-enhanced';
            console.log('âœ… èŠå¤©æ¨¡å¼å…«å­—MCPè®¡ç®—æˆåŠŸ');
          } else {
            console.log('âš ï¸ å…«å­—MCPè®¡ç®—å¤±è´¥:', baziResult.message);
          }
        } else {
          console.log('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç”Ÿè¾°æ•°æ®');
        }
      } catch (error: any) {
        console.warn('âš ï¸ èŠå¤©æ¨¡å¼å…«å­—MCPè°ƒç”¨å¤±è´¥:', error);
      }
    } else if (requestData.type === 'bazi') {
      // å¦‚æœæ˜¯å…«å­—ç±»å‹ä½†æ²¡æœ‰å‡ºç”Ÿä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
      console.log('âš ï¸ ç”¨æˆ·è¯·æ±‚å…«å­—åˆ†æä½†æœªæä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œä½¿ç”¨é€šç”¨åˆ†æ');
      analysisType = 'bazi-requested';
    }
    
    // åˆå§‹åŒ–çœŸæ­£çš„ModelScopeæœåŠ¡
    const realModelService = new RealModelScopeOnlineService({
      apiKey: process.env.MODELSCOPE_API_KEY || '',
      modelId: process.env.MODELSCOPE_MODEL || 'ZhipuAI/GLM-4.6',
      baseUrl: process.env.MODELSCOPE_BASE_URL || 'https://api-inference.modelscope.cn/v1'
    });
    
    // å¦‚æœç”¨æˆ·æä¾›äº†ç”Ÿè¾°å…«å­—ï¼Œå…ˆé€šè¿‡@cantian-ai/Bazi-MCPè·å–åˆ†æ
    if (requestData.birthInfo || requestData.type === 'bazi' || 
        extractBirthDataFromContext(requestData.context) || extractBirthDataFromQuestion(requestData.question)) {
      try {
        console.log('ğŸ”® è°ƒç”¨@cantian-ai/Bazi-MCPæœåŠ¡ï¼ˆèŠå¤©æ¨¡å¼ï¼‰...');
        
        // æå–æˆ–ä½¿ç”¨æä¾›çš„ç”Ÿè¾°æ•°æ®
        const birthData = requestData.birthInfo || 
                         extractBirthDataFromContext(requestData.context) ||
                         extractBirthDataFromQuestion(requestData.question);
        
        if (birthData) {
          const baziResult = await mcpService.calculateBazi(birthData);
          
          if (baziResult.success) {
            baziData = baziResult.data;
            analysisType = 'bazi-enhanced';
            console.log('âœ… èŠå¤©æ¨¡å¼å…«å­—MCPè®¡ç®—æˆåŠŸ');
          } else {
            console.log('âš ï¸ å…«å­—MCPè®¡ç®—å¤±è´¥:', baziResult.message);
          }
        } else {
          console.log('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ç”Ÿè¾°æ•°æ®');
        }
      } catch (error: any) {
        console.warn('âš ï¸ èŠå¤©æ¨¡å¼å…«å­—MCPè°ƒç”¨å¤±è´¥:', error);
      }
    } else if (requestData.type === 'bazi') {
      // å¦‚æœæ˜¯å…«å­—ç±»å‹ä½†æ²¡æœ‰å‡ºç”Ÿä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
      console.log('âš ï¸ ç”¨æˆ·è¯·æ±‚å…«å­—åˆ†æä½†æœªæä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œä½¿ç”¨é€šç”¨åˆ†æ');
      analysisType = 'bazi-requested';
    }
    
    // åˆå§‹åŒ–çœŸæ­£çš„ModelScopeæœåŠ¡
    const realModelService = new RealModelScopeOnlineService({
      apiKey: process.env.MODELSCOPE_API_KEY || '',
      modelId: process.env.MODELSCOPE_MODEL || 'ZhipuAI/GLM-4.6',
      baseUrl: process.env.MODELSCOPE_BASE_URL || 'https://api-inference.modelscope.cn/v1'
    });
    
    // æ„å»ºå¢å¼ºçš„é—®é¢˜æç¤º
    let enhancedQuestion = requestData.question;
    let systemPrompt = 'å åœå¸ˆ: æ‚¨å¥½ï¼æˆ‘æ˜¯å…«å­—å‘½ç†AIå åœå¸ˆã€‚è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å åœåˆ†æå’Œå»ºè®®ã€‚';
    
    if (baziData) {
      enhancedQuestion = `${requestData.question}\n\nè¯·å‚è€ƒä»¥ä¸‹å…«å­—åˆ†ææ•°æ®ï¼š\næ—¥ä¸»ï¼š${baziData.æ—¥ä¸» || 'æœªçŸ¥'}\nå…«å­—ï¼š${baziData.å…«å­— || 'æœªçŸ¥'}\nç”Ÿè‚–ï¼š${baziData.ç”Ÿè‚– || 'æœªçŸ¥'}\né˜³å†ï¼š${baziData.é˜³å† || 'æœªçŸ¥'}`;
      systemPrompt = 'å åœå¸ˆ: æ‚¨å¥½ï¼æˆ‘æ˜¯å…«å­—å‘½ç†AIå åœå¸ˆã€‚æˆ‘å·²ç»ä¸ºæ‚¨è¿›è¡Œäº†ä¸“ä¸šçš„å…«å­—åˆ†æï¼Œç°åœ¨åŸºäºæ‚¨çš„å…«å­—æ•°æ®ä¸ºæ‚¨æä¾›ç²¾å‡†çš„å åœå»ºè®®ã€‚';
    } else if (requestData.type === 'bazi') {
      enhancedQuestion = `${requestData.question}\n\næ³¨æ„ï¼šæ‚¨è¯·æ±‚çš„æ˜¯å…«å­—åˆ†æï¼Œä½†æœªæä¾›å‡ºç”Ÿä¿¡æ¯ã€‚æˆ‘å°†ä¸ºæ‚¨æä¾›ä¸€èˆ¬æ€§çš„å åœåˆ†æï¼Œå»ºè®®æ‚¨æä¾›å‡ºç”Ÿä¿¡æ¯ä»¥è·å¾—æ›´ç²¾å‡†çš„å…«å­—åˆ†æã€‚`;
      systemPrompt = 'å åœå¸ˆ: æ‚¨å¥½ï¼æˆ‘æ˜¯å…«å­—å‘½ç†AIå åœå¸ˆã€‚æ‚¨è¯·æ±‚çš„æ˜¯å…«å­—åˆ†æï¼Œä½†æœªæä¾›å‡ºç”Ÿä¿¡æ¯ã€‚æˆ‘å°†ä¸ºæ‚¨æä¾›ä¸€èˆ¬æ€§çš„å åœåˆ†æï¼Œå»ºè®®æ‚¨æä¾›å‡ºç”Ÿä¿¡æ¯ä»¥è·å¾—æ›´ç²¾å‡†çš„å…«å­—åˆ†æã€‚';
    }
    
    // è°ƒè¯•è¾“å‡º
    console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:', {
      enhancedQuestion,
      context: requestData.context,
      type: requestData.type,
      systemPrompt,
      baziData: !!baziData
    });

    // ä½¿ç”¨çœŸæ­£çš„ModelScope AIè¿›è¡Œåˆ†æ
    const result = await realModelService.generateFortune(
      enhancedQuestion,
      requestData.context,
      requestData.type,
      systemPrompt
    );

    console.log('âœ… å…«å­—MCP + ModelScope AIèŠå¤©åˆ†æå®Œæˆ:', {
      success: result.success,
      source: result.source,
      hasBaziData: !!baziData
    });

    const response: FortuneResponse = {
      id: uuidv4(),
      question: requestData.question,
      type: requestData.type || 'general',
      result: {
        ...result,
        baziMcpData: baziData
      },
      timestamp: new Date().toISOString(),
      processingTime: Date.now() - startTime
    };
    
    res.json(response);
  } catch (error: any) {
    console.error('âŒ å…«å­—MCP + ModelScope AIèŠå¤©å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'èŠå¤©æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•',
      timestamp: new Date().toISOString()
    });
  }
export default router;