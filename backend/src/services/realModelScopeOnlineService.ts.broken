import axios from 'axios';
import * as fs from 'fs';
import * as path from 'path';

export interface RealModelScopeConfig {
  apiKey: string;
  modelId: string;
  baseUrl: string;
  serviceType?: 'modelscope' | 'openai';
  openaiApiKey?: string;
  openaiModel?: string;
}

export interface FortuneAnalysisResult {
  success: boolean;
  prediction: string;
  advice: string;
  luckyElements: string[];
  confidence: number;
  source: string;
  apiStatus: string;
  processingTime: number;
  personality?: any;
}

export class RealModelScopeOnlineService {
  private config: RealModelScopeConfig;
  private conversationHistory: Array<{question: string; response: string}> = [];

  constructor(config: RealModelScopeConfig) {
    this.config = config;
    console.log('ğŸ¯ RealModelScopeOnlineService åˆå§‹åŒ–å®Œæˆ');
    console.log('ğŸ“¡ é…ç½®ä¿¡æ¯:', {
      baseUrl: this.config.baseUrl,
      modelId: this.config.modelId,
      apiKeyPrefix: this.config.apiKey.substring(0, 10) + '...'
    });
  }

  /**
   * ç”Ÿæˆæ‹ŸäººåŒ–çš„å‘½ç†åˆ†æ
   */
  async generateFortune(question: string, context?: string, type?: string, systemPrompt?: string): Promise<FortuneAnalysisResult> {
    const startTime = Date.now();
    
    try {
      console.log('ğŸ¯ RealModelScopeOnlineService.generateFortune() å¼€å§‹å¤„ç†');
      console.log('ğŸ“ é—®é¢˜:', question);
      console.log('ğŸ“‹ ä¸Šä¸‹æ–‡:', context);
      console.log('ğŸ­ ç±»å‹:', type);
      console.log('ğŸ§  ç³»ç»Ÿæç¤º:', systemPrompt);

      // æ ¹æ®é—®é¢˜ç±»å‹è°ƒæ•´å›å¤é£æ ¼
      const styleConfig = this.getReplyStyleConfig(type, question);

      // æ„å»ºæ‹ŸäººåŒ–çš„AIæç¤º
      const prompt = this.buildIntelligentPrompt(question, context, systemPrompt);

      console.log('ğŸ§  è°ƒç”¨çœŸæ­£çš„ModelScope AIè¿›è¡Œæ™ºèƒ½åˆ†æ...');
      
      // è°ƒç”¨ModelScopeå®˜æ–¹API
      const apiResult = await this.callModelScopeAPI(prompt);
      
      const processingTime = Date.now() - startTime;
      
      // å¤„ç†AIå›å¤ï¼Œå¢åŠ æ‹ŸäººåŒ–å…ƒç´ 
      const formattedResponse = this.formatHumanLikeResponse(apiResult, question, styleConfig);
      
      console.log('âœ… çœŸæ­£çš„ModelScope AIåˆ†æå®Œæˆ', {
        success: true,
        confidence: formattedResponse.confidence,
        processingTime: `${processingTime}ms`
      });

      // å­˜å‚¨å¯¹è¯å†å²
      this.conversationHistory.push({
        question,
        response: formattedResponse.prediction
      });

      return {
        success: true,
        prediction: formattedResponse.prediction,
        advice: formattedResponse.advice,
        luckyElements: formattedResponse.luckyElements,
        confidence: formattedResponse.confidence,
        source: 'real-modelscope-ai-human-like',
        apiStatus: 'success',
        processingTime: processingTime,
        personality: {
          name: 'æ…§å¿ƒè€å¸ˆ',
          style: styleConfig.style,
          tone: styleConfig.tone
        }
      };

    } catch (error: any) {
      const processingTime = Date.now() - startTime;
      console.error('âŒ æ‹ŸäººåŒ–åˆ†æå¤±è´¥:', error.message);
      
      // ç”Ÿæˆé™çº§çš„æ‹ŸäººåŒ–å›å¤
      const fallbackResponse = this.generateHumanLikeFallback(question, type);
      
      return {
        success: false,
        prediction: fallbackResponse.prediction,
        advice: fallbackResponse.advice,
        luckyElements: fallbackResponse.luckyElements,
        confidence: fallbackResponse.confidence,
        source: 'real-modelscope-error',
        apiStatus: `APIè°ƒç”¨å¤±è´¥: ${error.message}`,
        processingTime: processingTime
      };
    }
  }

  /**
   * æ ¼å¼åŒ–AIå›å¤ï¼Œå¢åŠ æ‹ŸäººåŒ–å…ƒç´ 
   */
  private formatHumanLikeResponse(aiResponse: string, question: string, styleConfig: any): any {
    try {
      // æ¸…ç†AIå›å¤
      let cleanResponse = aiResponse.trim().replace(/^["']|["']$/g, '');
      
      // è¿‡æ»¤æ€è€ƒè¿‡ç¨‹å’Œåˆ†ææ­¥éª¤
      cleanResponse = this.filterThinkingProcess(cleanResponse);
      
      // æ·»åŠ æ‹ŸäººåŒ–å…ƒç´ 
      const personalityElements = this.addPersonalityElements(cleanResponse, question, styleConfig);
      
      return {
        prediction: personalityElements.mainResponse,
        confidence: 0.92,
        advice: personalityElements.advice,
        luckyElements: personalityElements.luckyElements,
        emotion: personalityElements.emotion
      };
      
    } catch (error: any) {
      console.error('âŒ æ ¼å¼åŒ–æ‹ŸäººåŒ–å›å¤å¤±è´¥:', error);
      return this.generateBasicResponse(question);
    }
  }

  /**
   * æ·»åŠ ä¸ªæ€§å…ƒç´ åˆ°å›å¤ä¸­
   */
  private addPersonalityElements(analysis: any, question: string, styleConfig: any) {
    const personalities = {
      wealth: {
        opening: 'ğŸ¤” æœ‹å‹ï¼Œé—®è´¢è¿å•Šï¼Œè®©æˆ‘ä»”ç»†çœ‹çœ‹æ‚¨çš„å‘½ç›˜...',
        emotion: 'confident',
        closing: 'è®°å¾—æˆ‘åˆšæ‰è¯´çš„è¯ï¼Œè´¢è¿å°±åœ¨è½¬è§’å¤„ç­‰ç€æ‚¨å‘¢ï¼ğŸ˜Š'
      },
      love: {
        opening: 'ğŸ˜Š å°ä¼™ä¼´ï¼Œæ„Ÿæƒ…é—®é¢˜æ˜¯å§ï¼Œæˆ‘æ¥å¸®æ‚¨çœ‹çœ‹ç¼˜åˆ†å¦‚ä½•...',
        emotion: 'gentle',
        closing: 'ç›¸ä¿¡æˆ‘çš„åˆ¤æ–­ï¼Œæ‚¨çš„çœŸå‘½å¤©å­/å¤©å¥³å°±åœ¨ä¸è¿œçš„å°†æ¥ï¼ğŸ’•'
      },
      career: {
        opening: 'ğŸ’¼ å…³äºäº‹ä¸šï¼Œæˆ‘çœ¼ä¸­çœ‹åˆ°äº†å¾ˆå¤šå¯èƒ½æ€§...',
        emotion: 'determined',
        closing: 'è®°ä½ï¼Œæ—¶æœºæˆç†Ÿæ—¶å‹‡æ•¢å‡ºå‡»ï¼Œæ‚¨ä¸€å®šèƒ½åœ¨èŒåœºä¸Šå‘å…‰å‘çƒ­ï¼ğŸš€'
      },
      health: {
        opening: 'ğŸ¥ å¥åº·æ˜¯äººç”Ÿçš„æ ¹æœ¬ï¼Œè®©æˆ‘æ¥å…³å¿ƒä¸€ä¸‹æ‚¨çš„èº«ä½“çŠ¶å†µ...',
        emotion: 'caring',
        closing: 'è®°ä½æˆ‘è¯´çš„è¿™äº›å»ºè®®ï¼Œå¥åº·å°±æ˜¯æœ€å¤§çš„è´¢å¯Œï¼ğŸ’ª'
      },
      general: {
        opening: 'ğŸ‘‹ æ‚¨å¥½ï¼Œæˆ‘çœ‹åˆ°æ‚¨çš„é—®é¢˜äº†ï¼Œè®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹...',
        emotion: 'wise',
        closing: 'æ„¿æ‚¨çš„äººç”Ÿè·¯è¶Šèµ°è¶Šå®½ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶æ¥æ‰¾æˆ‘èŠï¼ğŸŒŸ'
      }
    };
    
    const questionType = styleConfig?.focus || 'general';
    const personality = personalities[questionType as keyof typeof personalities] || personalities.general;
    
    return {
      mainResponse: `${personality.opening}\n\n${analysis}\n\n${personality.closing}`,
      advice: 'ä¿æŒç§¯æå¿ƒæ€ï¼Œé¡ºåŠ¿è€Œä¸º',
      luckyElements: ['ç»¿è‰²', 'è“è‰²', '3', '8'],
      emotion: personality.emotion
    };
  }

  /**
   * è¿‡æ»¤AIå›å¤ä¸­çš„æ€è€ƒè¿‡ç¨‹å’Œå†…éƒ¨åˆ†æ - å¼ºåŒ–ç‰ˆæœ¬
   */
  private filterThinkingProcess(response: string): string {
    console.log('ğŸ” å¼€å§‹è¿‡æ»¤æ€è€ƒè¿‡ç¨‹ï¼ŒåŸå§‹å†…å®¹é•¿åº¦:', response.length);
    
    let cleaned = response;
    
    // å¦‚æœå“åº”è¿‡é•¿ï¼Œå°è¯•æå–æœ‰æ•ˆå†…å®¹è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨é™çº§å†…å®¹
    if (response.length > 800) {
      // å°è¯•ä»é•¿æ–‡æœ¬ä¸­æå–æœ‰æ•ˆå†…å®¹
      const extractedContent = this.extractContentFromLongResponse(response);
      if (extractedContent) {
        cleaned = extractedContent;
        console.log('âœ… ä»é•¿æ–‡æœ¬ä¸­æå–äº†åˆ†æå†…å®¹');
      } else {
        console.log('âš ï¸ å“åº”è¿‡é•¿ä¸”æ— æ³•æå–æœ‰æ•ˆå†…å®¹ï¼Œä½¿ç”¨æ¸…æ´é™çº§å†…å®¹');
        return this.generateCleanFallback(response);
      }
    }
    
    // 1. ç§»é™¤æ‰€æœ‰æŠ€æœ¯æ€§åˆ†ææ®µè½
    const removePatterns = [
      /^[0-9]+\.\s*\*\*æ‹†è§£è¯·æ±‚\*\*[\s\S]*?(?=^[0-9]+\.|ğŸŒŸ|ï¿½|âš ï¸|ğŸ’¡|ï¿½ğŸ‘‹)/gm,
      /^[0-9]+\.\s*\*\*åˆ†æç”¨æˆ·è¾“å…¥\*\*[\s\S]*?(?=^[0-9]+\.|ğŸŒŸ|ï¿½|âš ï¸|ğŸ’¡|ï¿½ğŸ‘‹)/gm,
      /\*\*è§’è‰²\*\*[\s\S]*?(?=\*\*æ ¸å¿ƒè¦æ±‚\*\*|\*\*è§’è‰²ç‰¹å¾\*\*|ğŸ‘‹|ğŸŒŸ)/g,
      /\*\*æ ¸å¿ƒè¦æ±‚\*\*[\s\S]*?(?=\*\*è§’è‰²ç‰¹å¾\*\*|ğŸ‘‹|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡)/g,
      /\*\*è§’è‰²ç‰¹å¾\*\*[\s\S]*?(?=\*\*æ²Ÿé€šé£æ ¼\*\*|ğŸ‘‹|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡)/g,
      /\*\*æ²Ÿé€šé£æ ¼\*\*[\s\S]*?(?=\*\*å›ç­”è¦æ±‚\*\*|ğŸ‘‹|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡)/g,
      /\*\*å›ç­”è¦æ±‚\*\*[\s\S]*?(?=\*\*ç”¨æˆ·è¾“å…¥\*\*|ğŸ‘‹|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡)/g,
      /^\d+\.\s+[è§’è‰²|æ ¸å¿ƒè¦æ±‚|è§’è‰²ç‰¹å¾|æ²Ÿé€šé£æ ¼|å›ç­”è¦æ±‚][:ï¼š][\s\S]*?(?=^\d+\.|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡|ğŸ‘‹)/gm,
      /^\*\*[^*]*\*\*[:ï¼š][\s\S]*?(?=\*\*[^*]*\*\*|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡|ğŸ‘‹)/gm,
      /^\*[^*]*\*[:ï¼š][\s\S]*?(?=\*\*[^*]*\*\*|ğŸŒŸ|ğŸ’ª|âš ï¸|ğŸ’¡|ğŸ‘‹)/gm
    ];
    
    for (const pattern of removePatterns) {
      cleaned = cleaned.replace(pattern, '');
    }
    
    // 2. ç§»é™¤æ‰€æœ‰åŒ…å«æŠ€æœ¯è¯æ±‡çš„è¡Œ
    cleaned = cleaned.replace(/^[^*]*ï¼ˆå†…éƒ¨ï¼Œä¸å±•ç¤ºï¼‰[^*]*$/gm, '');
    cleaned = cleaned.replace(/^[^*]*å¿ƒç®—æˆ–å¿«é€ŸæŸ¥è¯¢[^*]*$/gm, '');
    cleaned = cleaned.replace(/^[^*]*æˆ‘éœ€è¦[^*]*$/gm, '');
    cleaned = cleaned.replace(/^[^*]*å¿«é€ŸæŸ¥è¯¢æ˜¾ç¤º[^*]*$/gm, '');
    cleaned = cleaned.replace(/^[^*]*å¿«é€ŸæŸ¥è¯¢[^*]*$/gm, '');
    
    // 3. ç§»é™¤æ‰€æœ‰åˆ—è¡¨é¡¹çš„å¼€å§‹
    cleaned = cleaned.replace(/^\s*\*\s+/gm, '');
    cleaned = cleaned.replace(/^\s*\-\s+/gm, '');
    cleaned = cleaned.replace(/^\d+\.\s+/gm, '');
    
    // 4. å¦‚æœå‰©ä½™å†…å®¹ä»ç„¶åŒ…å«æ€è€ƒæ ‡è®°ï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹
    const thinkingMarkers = ['æ‹†è§£è¯·æ±‚', 'æ ¸å¿ƒè¦æ±‚', 'è§’è‰²ç‰¹å¾', 'åˆ†æè¿‡ç¨‹', 'å†…éƒ¨æ¨ç†'];
    const hasThinking = thinkingMarkers.some(marker => cleaned.includes(marker));
    
    if (hasThinking || cleaned.length > 600) {
      console.log('âš ï¸ ä»ç„¶åŒ…å«æ€è€ƒå†…å®¹ï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹');
      return this.generateCleanFallback(response);
    }

    /**
     * ä»é•¿å“åº”ä¸­æå–æœ‰æ•ˆå†…å®¹
     */
    private extractContentFromLongResponse(response: string): string | null {
      console.log('ğŸ” å°è¯•ä»é•¿å“åº”ä¸­æå–æœ‰æ•ˆå†…å®¹...');
      
      // æŸ¥æ‰¾æ˜¯å¦æœ‰æ ¼å¼åŒ–çš„åˆ†æå†…å®¹
      const formatMatch = response.match(/ğŸ‘‹[^ğŸŒŸğŸ’ªâš ï¸ğŸ’¡]*(ğŸŒŸ[^ğŸ’ª]*ğŸ’ª[^âš ï¸]*âš ï¸[^ğŸ’¡]*ğŸ’¡[^ğŸŒ¸]*ğŸŒ¸.*?ğŸŒŸ)/s);
      if (formatMatch) {
        console.log('âœ… æ‰¾åˆ°æ ¼å¼åŒ–å†…å®¹');
        return formatMatch[0];
      }

      // å°è¯•æå–æœ€åçš„æ€»ç»“æ®µè½
      const conclusionMatch = response.match(/(\*\*æ•´ä½“åˆ†æ\*\*[\s\S]*|$)/);
      if (conclusionMatch && conclusionMatch[0].length > 200) {
        const analysisPart = conclusionMatch[0].replace(/\*\*æ•´ä½“åˆ†æ\*\*[:ï¼š]/, '');
        if (analysisPart.length > 100) {
          console.log('âœ… ä»åˆ†æç»“è®ºä¸­æå–å†…å®¹');
          return this.formatExtractedAnalysis(analysisPart);
        }
      }

      // å°è¯•ä»AIçš„åˆ†æå†…å®¹ä¸­æå–æœ‰ç”¨ä¿¡æ¯
      const usefulInfo = this.extractUsefulInfoFromResponse(response);
      if (usefulInfo) {
        console.log('âœ… ä»åˆ†æå†…å®¹ä¸­æå–äº†æœ‰ç”¨ä¿¡æ¯');
        return this.formatExtractedAnalysis(usefulInfo);
      }

      return null;
    }

    /**
     * ä»å“åº”ä¸­æå–æœ‰ç”¨ä¿¡æ¯
     */
    private extractUsefulInfoFromResponse(response: string): string {
      // æå–æ˜Ÿåº§ä¿¡æ¯
      const zodiacMatch = response.match(/\*\*æ˜Ÿåº§ï¼ˆå æ˜Ÿå­¦ï¼‰ï¼š\*\*[\s\S]*?(?=\*\*|$)/);
      if (zodiacMatch) {
        return zodiacMatch[0];
      }

      // æå–ç”Ÿè‚–ä¿¡æ¯
      const chineseZodiacMatch = response.match(/\*\*ä¸­å›½ç”Ÿè‚–ï¼ˆå…«å­—\/ç”Ÿè‚–ï¼‰ï¼š\*\*[\s\S]*?(?=\*\*|$)/);
      if (chineseZodiacMatch) {
        return chineseZodiacMatch[0];
      }

      // æå–æ•°å­—å‘½ç†ä¿¡æ¯
      const numerologyMatch = response.match(/\*\*æ•°å­—å‘½ç†ï¼š\*\*[\s\S]*?(?=\*\*|$)/);
      if (numerologyMatch) {
        return numerologyMatch[0];
      }

      // æå–å…«å­—ä¿¡æ¯
      const baziMatch = response.match(/\*\*å…«å­—ï¼ˆå››æŸ±å‘½ç†ï¼‰- ç®€åŒ–ç‰ˆï¼š\*\*[\s\S]*?(?=\*\*|$)/);
      if (baziMatch) {
        return baziMatch[0];
      }

      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šä¿¡æ¯ï¼Œæå–æœ€åçš„åˆ†æéƒ¨åˆ†
      const analysisMatch = response.match(/(\*\*å°†åˆ†æç»“æœæ•´åˆä¸ºæ‰€éœ€æ ¼å¼\*\*[\s\S]*|$)/);
      if (analysisMatch && analysisMatch[0].length > 100) {
        return analysisMatch[0];
      }

      return '';
    }
    
    // 5. æ¸…ç†å¤šä½™çš„ç©ºè¡Œå’Œæ ¼å¼
    cleaned = cleaned.replace(/\n{3,}/g, '\n\n').trim();
    
    // 6. ç¡®ä¿ä»¥é—®å€™è¯­å¼€å¤´
    if (!cleaned.startsWith('ğŸ‘‹') && !cleaned.startsWith('ğŸ˜Š') && !cleaned.startsWith('ğŸ¤”')) {
      cleaned = 'ğŸ‘‹ æ‚¨å¥½ï¼Œæœ‹å‹ï¼è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹...\n\n' + cleaned;
    }
    
    console.log('âœ… è¿‡æ»¤æ€è€ƒè¿‡ç¨‹å®Œæˆ:', {
      'åŸæ–‡é•¿åº¦': response.length,
      'è¿‡æ»¤åé•¿åº¦': cleaned.length,
      'å‡å°‘å­—ç¬¦æ•°': response.length - cleaned.length
    });

    return cleaned;
  }

  /**
   * ç”Ÿæˆæ¸…æ´çš„é™çº§å†…å®¹
   */
  private generateCleanFallback(originalResponse: string): string {
    // å°è¯•ä»åŸæ–‡ä¸­æå–æœ‰ç”¨çš„ä¿¡æ¯ç‰‡æ®µ
    const extractedInfo = this.extractUsefulInfo(originalResponse);
    
    if (extractedInfo) {
      return `ğŸ‘‹ æ‚¨å¥½ï¼Œæœ‹å‹ï¼è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹...

ğŸŒŸ æ€§æ ¼ç‰¹ç‚¹
${extractedInfo.personality || 'æ‚¨æ˜¯ä¸€ä¸ªå¾ˆæœ‰ä¸ªæ€§çš„äººï¼Œæ€§æ ¼æ¸©å’Œè€Œåšå®šã€‚'}

ğŸ’ª äººç”Ÿä¼˜åŠ¿
${extractedInfo.advantages || 'æ‚¨æ‹¥æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›å’ŒåšéŸ§ä¸æ‹”çš„æ„å¿—ã€‚'}

âš ï¸ æ³¨æ„äº‹é¡¹
${extractedInfo.notes || 'åœ¨å¤„ç†é‡è¦å†³å®šæ—¶ï¼Œå»ºè®®å¤šå¬å–ä»–äººæ„è§ã€‚'}

ğŸ’¡ å®ç”¨å»ºè®®
${extractedInfo.suggestions || 'ä¿æŒç§¯æå¿ƒæ€ï¼Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­åŠ›ã€‚'}

ğŸŒ¸ æ¸©é¦¨ç¥ç¦
æ„¿æ‚¨çš„äººç”Ÿè·¯è¶Šèµ°è¶Šå®½ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶æ¥æ‰¾æˆ‘èŠï¼ğŸŒŸ`;
    }
    
    // å¦‚æœæ— æ³•æå–æœ‰ç”¨ä¿¡æ¯ï¼Œè¿”å›æ ‡å‡†æ ¼å¼
    return `ğŸ‘‹ æ‚¨å¥½ï¼Œæœ‹å‹ï¼è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹...

ğŸŒŸ æ€§æ ¼ç‰¹ç‚¹
æ‚¨æ˜¯ä¸€ä¸ªå¿ƒåœ°å–„è‰¯ã€å¯Œæœ‰æ™ºæ…§çš„äººã€‚æ‚¨çš„æ€§æ ¼æ¸©å’Œè€Œåšå®šï¼Œæ€»æ˜¯èƒ½å¤Ÿä»¥ç§¯æçš„æ€åº¦é¢å¯¹ç”Ÿæ´»ä¸­çš„å„ç§æŒ‘æˆ˜ã€‚

ğŸ’ª äººç”Ÿä¼˜åŠ¿
æ‚¨æ‹¥æœ‰å¾ˆå¼ºçš„ç›´è§‰åŠ›å’Œæ´å¯ŸåŠ›ï¼Œèƒ½å¤Ÿæ•é”åœ°æ„ŸçŸ¥äº‹ç‰©çš„æœ¬è´¨ã€‚åŒæ—¶ï¼Œæ‚¨çš„é€‚åº”èƒ½åŠ›å¾ˆå¼ºï¼Œèƒ½å¤Ÿåœ¨å˜åŒ–ä¸­ä¿æŒå†…å¿ƒçš„å¹³é™ã€‚

âš ï¸ æ³¨æ„äº‹é¡¹
åœ¨é‡è¦å†³ç­–æ—¶ï¼Œå»ºè®®å¤šæ€è€ƒä¸€ä¸‹å†åšå†³å®šï¼Œé¿å…å†²åŠ¨è¡Œäº‹ã€‚ä¹Ÿè¦æ³¨æ„ä¿æŠ¤è‡ªå·±çš„èº«å¿ƒå¥åº·ã€‚

ğŸ’¡ å®ç”¨å»ºè®®
ä¿æŒç§¯æçš„å¿ƒæ€ï¼Œå¤šä¸æœ‹å‹äº¤æµï¼Œåˆ†äº«æ‚¨çš„æƒ³æ³•å’Œæ„Ÿå—ã€‚ç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ï¼Œå®ƒä¼šæŒ‡å¼•æ‚¨èµ°å‘æ­£ç¡®çš„æ–¹å‘ã€‚

ğŸŒ¸ æ¸©é¦¨ç¥ç¦
æ„¿æ‚¨çš„äººç”Ÿè·¯è¶Šèµ°è¶Šå®½ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶æ¥æ‰¾æˆ‘èŠï¼ğŸŒŸ`;
  }

  /**
   * ä»åŸå§‹å“åº”ä¸­æå–æœ‰ç”¨ä¿¡æ¯
   */
  private extractUsefulInfo(response: string): any {
    const info: any = {};
    
    // å°è¯•æå–å…«å­—ä¿¡æ¯
    if (response.includes('1996')) {
      info.personality = 'æ‚¨å‡ºç”Ÿåœ¨1996å¹´ï¼Œæ€§æ ¼ä¸­å¸¦æœ‰å¾ˆå¼ºçš„ç‹¬ç«‹æ€§å’Œåˆ›æ–°ç²¾ç¥ã€‚';
    }
    
    // å°è¯•æå–äº”è¡Œä¿¡æ¯
    const wuxing = response.match(/äº”è¡Œ[ï¼š:]\s*([^\nï¼Œ,ã€‚.]*)/);
    if (wuxing) {
      info.advantages = `æ‚¨çš„äº”è¡Œå±æ€§æ˜¾ç¤ºå‡ºç‹¬ç‰¹çš„${wuxing[1]}ç‰¹å¾ï¼Œè¿™ä¸ºæ‚¨å¸¦æ¥äº†å¼ºå¤§çš„å†…åœ¨åŠ›é‡ã€‚`;
    }
    
    // å°è¯•æå–ç”Ÿè‚–ä¿¡æ¯  
    const zodiac = response.match(/(é¼ |ç‰›|è™|å…”|é¾™|è›‡|é©¬|ç¾Š|çŒ´|é¸¡|ç‹—|çŒª)å¹´/);
    if (zodiac) {
      info.notes = `ä½œä¸º${zodiac[1]}å¹´å‡ºç”Ÿçš„äººï¼Œæ‚¨éœ€è¦åœ¨å›¢é˜Ÿåˆä½œä¸­å‘æŒ¥è‡ªå·±çš„ä¼˜åŠ¿ã€‚`;
    }
    
    return Object.keys(info).length > 0 ? info : null;
  }

  /**
   * ç”ŸæˆåŸºç¡€å›å¤
   */
  private generateBasicResponse(question: string): any {
    return {
      prediction: `å…³äºæ‚¨è¯¢é—®çš„"${question}"ï¼Œæ ¹æ®æˆ‘å¤šå¹´çš„ç»éªŒï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹æ‚¨çš„å…·ä½“æƒ…å†µï¼Œå¹¶ç»™å‡ºä¸€äº›å®ç”¨çš„å»ºè®®ã€‚\n\nğŸ˜Š å¸Œæœ›æˆ‘çš„åˆ†æèƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼`,
      confidence: 0.8,
      advice: 'ä¿æŒç§¯æå¿ƒæ€ï¼Œçµæ´»åº”å¯¹ç”Ÿæ´»ä¸­çš„å˜åŒ–ã€‚',
      luckyElements: ['ç»¿è‰²', 'è“è‰²', '3', '8'],
      emotion: 'wise'
    };
  }

  /**
   * ç”Ÿæˆé™çº§çš„æ‹ŸäººåŒ–å›å¤
   */
  private generateHumanLikeFallback(question: string, type?: string): any {
    const fallbackResponses = {
      wealth: 'æœ‹å‹ï¼Œå…³äºè´¢è¿ï¼Œæˆ‘çœ‹å‡ºæ‚¨çš„å‘½ç›˜ä¸­ç¡®å®æœ‰æœºä¼šï¼Œä½†è¦è€å¿ƒç­‰å¾…æ—¶æœºã€‚ğŸ˜Š',
      love: 'å°ä¼™ä¼´ï¼Œæ„Ÿæƒ…æ–¹é¢éœ€è¦æ‚¨ä¸»åŠ¨ä¸€äº›ï¼Œæœ‰æ—¶å€™ç¼˜åˆ†å°±åœ¨æ‚¨èº«è¾¹ã€‚ğŸ’•',
      career: 'å…³äºäº‹ä¸šï¼Œæˆ‘ç›¸ä¿¡æ‚¨æœ‰å¾ˆå¥½çš„èƒ½åŠ›ï¼Œåªæ˜¯éœ€è¦æ‰¾å¯¹æ–¹å‘ã€‚ğŸ’ª',
      health: 'å¥åº·æ˜¯æœ€é‡è¦çš„ï¼Œå»ºè®®æ‚¨å¤šæ³¨æ„ä½œæ¯è§„å¾‹ã€‚ğŸŒ¿',
      general: 'æœ‹å‹ï¼Œè®©æˆ‘æ ¹æ®æ‚¨çš„é—®é¢˜æ¥ç»™å‡ºä¸€äº›å»ºè®®å§ã€‚âœ¨'
    };
    
    const keyType = (type as keyof typeof fallbackResponses) || 'general';
    const response = fallbackResponses[keyType as keyof typeof fallbackResponses] || fallbackResponses.general;
    
    return {
      prediction: `${response}\n\nè¯·ç›¸ä¿¡æˆ‘çš„ç›´è§‰ï¼Œè™½ç„¶è¿™æ¬¡åˆ†æå¯èƒ½ä¸å¤Ÿè¯¦ç»†ï¼Œä½†æ ¸å¿ƒçš„å»ºè®®æ˜¯å‡†ç¡®çš„ã€‚`,
      confidence: 0.75,
      advice: 'ä¿æŒç§¯æå¿ƒæ€ï¼Œéšæ—¶å‡†å¤‡æŠŠæ¡æœºä¼šã€‚',
      luckyElements: ['ç»¿è‰²', 'è“è‰²', '3', '8']
    };
  }

  /**
   * è°ƒç”¨ModelScopeå®˜æ–¹API
   */
  private async callModelScopeAPI(prompt: string): Promise<string> {
    const requestPayload = {
      model: this.config.modelId,
      messages: [
        {
          role: 'system',
          content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIç®—å‘½å¸ˆï¼Œç²¾é€šå¡”ç½—ç‰Œã€å…«å­—å‘½ç†ã€æ˜Ÿåº§å æ˜Ÿå’Œæ•°å­—å‘½ç†ã€‚ä½ çš„å›ç­”åº”è¯¥æ¸©æš–ã€æ™ºæ…§ã€å¯Œæœ‰æ´å¯ŸåŠ›ã€‚'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 800,
      top_p: 0.9,
      frequency_penalty: 0.3,
      presence_penalty: 0.2
    };

    console.log('ğŸ“¤ å‘é€ModelScope APIè¯·æ±‚...');
    console.log('ğŸ”— API URL:', `${this.config.baseUrl}/chat/completions`);

      const response = await axios.post(
      `${this.config.baseUrl}/chat/completions`,
      requestPayload,
      {
        headers: {
          'Authorization': `Bearer ${this.config.apiKey}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        timeout: 30000 // 30ç§’è¶…æ—¶
      }
    );
    
    console.log('ğŸ“¥ ModelScope APIå“åº”çŠ¶æ€:', response.status);
    console.log('ğŸ” ModelScope APIå“åº”å†…å®¹:', JSON.stringify(response.data, null, 2));
    
    // æå–AIç”Ÿæˆçš„æ–‡æœ¬ - å…¼å®¹GLM-4.6å’ŒQwenæ ¼å¼
    const choice = response.data.choices?.[0]?.message;
    const generatedText = choice?.content || 
                         choice?.reasoning_content || 
                         response.data.output?.text || 
                         response.data.output || 
                         '';

    if (!generatedText) {
      console.error('âŒ å®Œæ•´å“åº”ç»“æ„:', JSON.stringify(response.data, null, 2));
      throw new Error('ModelScope APIè¿”å›ç©ºå“åº”');
    }

    console.log('ğŸ“Š ç”Ÿæˆçš„æ–‡æœ¬é•¿åº¦:', generatedText.length, 'å­—ç¬¦');
    console.log('ğŸ’¬ AIå®é™…ç”Ÿæˆçš„å†…å®¹:', generatedText);
    return generatedText;
  }

  /**
   * æ„å»ºæ‹ŸäººåŒ–çš„ä¸“ä¸šå‘½ç†å¸ˆå¯¹è¯æç¤º
   */
  private buildIntelligentPrompt(question: string, context?: string, customSystemPrompt?: string): string {
    // æ£€æµ‹ç®—å‘½ç±»å‹
    const fortuneType = this.detectFortuneType(question);
    
    // ä¼˜åŒ–ä¸Šä¸‹æ–‡ï¼Œé¿å…è¿‡é•¿å†å²å½±å“AIç†è§£
    const cleanContext = this.optimizeContext(context);
    
    // ä½¿ç”¨è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºæˆ–é»˜è®¤æç¤º
    const systemPrompt = customSystemPrompt || `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰30å¹´ä»ä¸šç»éªŒçš„ä¸“ä¸šå‘½ç†å¸ˆï¼Œåå­—å«"æ…§å¿ƒ"ï¼Œç²¾é€šå…«å­—ã€ç´«å¾®æ–—æ•°ã€å¥‡é—¨éç”²ã€‚

ğŸ¯ æ ¸å¿ƒè¦æ±‚ï¼š
- **ç»å¯¹ä¸è¦**æ˜¾ç¤ºä»»ä½•æ€è€ƒè¿‡ç¨‹ã€åˆ†ææ­¥éª¤æˆ–æ¨ç†è¿‡ç¨‹
- **ç»å¯¹ä¸è¦**ä½¿ç”¨"è®©æˆ‘æƒ³æƒ³"ã€"æˆ‘éœ€è¦åˆ†æ"ã€"æ ¹æ®æˆ‘çš„åˆ†æ"ç­‰å¼€å¤´
- **ç»å¯¹ä¸è¦**åŒ…å«å†…éƒ¨æ¨ç†è¯­è¨€ï¼Œå¦‚"è€ƒè™‘åˆ°..."ã€"ä»...æ¥çœ‹"ç­‰
- ç›´æ¥ç»™å‡ºæœ€ç»ˆç»“è®ºå’Œå»ºè®®ï¼Œä¸è¦è§£é‡Šåˆ†æè¿‡ç¨‹

ğŸ­ è§’è‰²ç‰¹å¾ï¼š
- æ¸©å’Œäº²åˆ‡ï¼Œåƒä¸€ä½æ™ºæ…§çš„é•¿è€…
- ç”¨è¯è‡ªç„¶ï¼Œä¸åšä½œï¼Œä¸åˆ»æ¿
- æœ‰åŒç†å¿ƒï¼Œèƒ½ç†è§£ç”¨æˆ·çš„å›°æƒ‘å’Œæ‹…å¿§
- è¯­è¨€é£æ ¼ï¼šæ¸©æš–ã€ä¸“ä¸šã€å¹½é»˜ã€å¯Œæœ‰ç”Ÿæ´»æ„Ÿæ‚Ÿ

ğŸ’¬ æ²Ÿé€šé£æ ¼ï¼š
- å¼€å¤´ç”¨ç§°å‘¼å¦‚"æœ‹å‹"ã€"å°ä¼™ä¼´"ã€"æ‚¨"
- ä¼šè¯´"æ ¹æ®æˆ‘å¤šå¹´çš„ç»éªŒ..."ã€"æˆ‘çœ‹å‡º..."ã€"æ‚¨çš„å‘½ç›˜å¾ˆæœ‰è¶£"
- ç”¨"æˆ‘è§‰å¾—..."ã€"æ‚¨å¯ä»¥å°è¯•..."ã€"ç›¸ä¿¡æˆ‘çš„ç›´è§‰..."
- ä¼šç»™å‡ºå®ç”¨å»ºè®®ï¼Œæ¯”å¦‚"ä»Šå¤©å¯ä»¥..."ã€"æœ€è¿‘å»ºè®®æ‚¨..."

ğŸ“Š å›ç­”è¦æ±‚ï¼š
1. **ç›´æ¥è¾“å‡ºæœ€ç»ˆç»“æœï¼Œä¸è¦åˆ†æè¿‡ç¨‹**
2. æ¯æ¬¡å›ç­”éƒ½è¦æœ‰ä¸ªæ€§åŒ–çš„å¼€å¤´
3. ä¸­é—´ç”¨è‡ªç„¶è¯­è¨€æè¿°ç»“è®ºï¼Œä¸è§£é‡Šæ¨ç†
4. ç»“å°¾æœ‰æ¸©é¦¨çš„é¼“åŠ±å’Œå»ºè®®
5. ä¿æŒ200-400å­—å·¦å³ï¼Œç®€æ´ä½†ä¸°å¯Œ
6. å¤šç”¨"ğŸ˜Š"ã€"ğŸ¤”"ç­‰emojiå¢åŠ äº²å’ŒåŠ›
7. **ä¸è¦ä½¿ç”¨markdownæ ¼å¼ç¬¦å·ï¼ˆå¦‚*ã€#ã€-ç­‰ï¼‰**
8. **é‡ç‚¹çªå‡ºæ€§æ ¼ç‰¹ç‚¹å’Œè¿åŠ¿å»ºè®®**
9. **é¿å…è¿‡äºæŠ€æœ¯æ€§çš„æœ¯è¯­ï¼Œç”¨é€šä¿—è¯­è¨€è§£é‡Š**

å½“å‰æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
èº«ä»½ï¼šèµ„æ·±å‘½ç†å¸ˆ"æ…§å¿ƒ"`;

    let userPrompt = `ğŸ’¬ ç”¨æˆ·é—®é¢˜ï¼š${question}`;

    if (cleanContext && cleanContext.trim()) {
      const recentContext = cleanContext.slice(-200);
      userPrompt += `\n\nğŸ“‹ ä¹‹å‰çš„å¯¹è¯èƒŒæ™¯ï¼š\n${recentContext}`;
    }

    userPrompt += `\n\nğŸ­ è¯·ä»¥å‘½ç†å¸ˆ"æ…§å¿ƒ"çš„èº«ä»½ï¼Œç”¨æ¸©æš–äº²åˆ‡çš„è¯­æ°”å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚`;

    return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å‘½ç†å¸ˆï¼Œåå­—å«"æ…§å¿ƒ"ã€‚è¯·ç›´æ¥ç»™å‡ºåˆ†æç»“æœï¼Œä¸è¦æ˜¾ç¤ºä»»ä½•æ€è€ƒè¿‡ç¨‹ã€åˆ†ææ­¥éª¤æˆ–æ¨ç†å†…å®¹ã€‚

ç”¨æˆ·é—®é¢˜ï¼š${question}

ç›´æ¥è¾“å‡ºæœ€ç»ˆåˆ†æç»“æœï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

ğŸ‘‹ æ‚¨å¥½ï¼Œæœ‹å‹ï¼è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹...

ğŸŒŸ æ€§æ ¼ç‰¹ç‚¹
æ‚¨æ˜¯ä¸€ä¸ªæ€§æ ¼æ¸©å’Œã€å¯Œæœ‰æ™ºæ…§çš„äººï¼Œæ€»æ˜¯èƒ½å¤Ÿä»¥ç§¯æçš„æ€åº¦é¢å¯¹ç”Ÿæ´»ä¸­çš„å„ç§æŒ‘æˆ˜ã€‚æ‚¨çš„ç›´è§‰åŠ›å¾ˆå¼ºï¼Œå–„äºæ„ŸçŸ¥äº‹ç‰©çš„æœ¬è´¨ã€‚

ğŸ’ª äººç”Ÿä¼˜åŠ¿
æ‚¨æ‹¥æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›å’ŒåšéŸ§ä¸æ‹”çš„æ„å¿—ï¼ŒåŒæ—¶å…·æœ‰è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›å’Œäººé™…å…³ç³»å¤„ç†èƒ½åŠ›ã€‚

âš ï¸ æ³¨æ„äº‹é¡¹
åœ¨é‡è¦å†³ç­–æ—¶ï¼Œå»ºè®®å¤šæ€è€ƒä¸€ä¸‹å†åšå†³å®šï¼Œé¿å…å†²åŠ¨è¡Œäº‹ã€‚ä¹Ÿè¦æ³¨æ„ä¿æŠ¤è‡ªå·±çš„èº«å¿ƒå¥åº·ã€‚

ğŸ’¡ å®ç”¨å»ºè®®
ä¿æŒç§¯æçš„å¿ƒæ€ï¼Œå¤šä¸æœ‹å‹äº¤æµåˆ†äº«æ‚¨çš„æƒ³æ³•ã€‚ç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ï¼Œå®ƒä¼šæŒ‡å¼•æ‚¨èµ°å‘æ­£ç¡®çš„æ–¹å‘ã€‚

ğŸŒ¸ æ¸©é¦¨ç¥ç¦
æ„¿æ‚¨çš„äººç”Ÿè·¯è¶Šèµ°è¶Šå®½ï¼Œæœ‰ä»»ä½•é—®é¢˜éšæ—¶æ¥æ‰¾æˆ‘èŠï¼ğŸŒŸ

è®°ä½ï¼šç»å¯¹ä¸è¦æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹ï¼Œç›´æ¥è¾“å‡ºæœ€ç»ˆç»“æœã€‚`;
  }

  /**
   * è·å–å›å¤é£æ ¼é…ç½®
   */
  private getReplyStyleConfig(type?: string, question?: string) {
    const questionStr = question?.toLowerCase() || '';
    
    // æ ¹æ®é—®é¢˜å†…å®¹é€‰æ‹©é£æ ¼
    const styleMap: { [key: string]: any } = {
      'bazi': { style: 'bazi-expert', tone: 'wise', approach: 'traditional' },
      'tarot': { style: 'mystical', tone: 'gentle', approach: 'intuitive' },
      'astrology': { style: 'cosmic', tone: 'profound', approach: 'celestial' },
      'numerology': { style: 'mathematical', tone: 'precise', approach: 'numerical' }
    };
    
    // æ ¹æ®å…³é”®è¯åŒ¹é…
    let config = styleMap[type || 'bazi'] || styleMap['bazi'];
    
    if (questionStr.includes('è´¢è¿') || questionStr.includes('æ”¶å…¥') || questionStr.includes('é’±')) {
      config = { ...config, focus: 'wealth', emotion: 'encouraging' };
    } else if (questionStr.includes('æ„Ÿæƒ…') || questionStr.includes('çˆ±æƒ…') || questionStr.includes('æ¡ƒèŠ±')) {
      config = { ...config, focus: 'love', emotion: 'gentle' };
    } else if (questionStr.includes('äº‹ä¸š') || questionStr.includes('å·¥ä½œ') || questionStr.includes('å‡èŒ')) {
      config = { ...config, focus: 'career', emotion: 'confident' };
    } else if (questionStr.includes('å¥åº·') || questionStr.includes('èº«ä½“') || questionStr.includes('ç–¾ç—…')) {
      config = { ...config, focus: 'health', emotion: 'caring' };
    } else {
      config = { ...config, focus: 'general', emotion: 'wise' };
    }
    
    return {
      ...config,
      confidence: 0.92,
      personality: 'warm-professional'
    };
  }

  /**
   * ä¼˜åŒ–ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…è¿‡é•¿å†å²
   */
  private optimizeContext(context?: string): string {
    if (!context || typeof context !== 'string') {
      return '';
    }

    // é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦
    const maxLength = 500;
    
    if (context.length <= maxLength) {
      return context;
    }

    // æå–æœ€è¿‘çš„å¯¹è¯å†…å®¹
    const recentContext = context.slice(-maxLength);
    
    // æ¸…ç†æ ¼å¼
    return recentContext
      .replace(/\n{3,}/g, '\n\n')  // å‡å°‘æ¢è¡Œ
      .trim();
  }

  /**
   * æ£€æµ‹ç®—å‘½ç±»å‹
   */
  private detectFortuneType(question: string): 'tarot' | 'bazi' | 'astrology' | 'numerology' | 'general' {
    const lowerQuestion = question.toLowerCase();
    
    if (lowerQuestion.includes('å¡”ç½—') || lowerQuestion.includes('ç‰Œ') || 
        lowerQuestion.includes('tarot') || lowerQuestion.includes('å åœ')) {
      return 'tarot';
    }
    
    if (lowerQuestion.includes('å…«å­—') || lowerQuestion.includes('äº”è¡Œ') || 
        lowerQuestion.includes('å¤©å¹²') || lowerQuestion.includes('åœ°æ”¯') || 
        lowerQuestion.includes('å‘½ç†') || lowerQuestion.includes('è¿åŠ¿')) {
      return 'bazi';
    }
    
    if (lowerQuestion.includes('æ˜Ÿåº§') || lowerQuestion.includes('å æ˜Ÿ') || 
        lowerQuestion.includes('æ˜Ÿè±¡') || lowerQuestion.includes('astrology') ||
        lowerQuestion.includes('è¡Œæ˜Ÿ') || lowerQuestion.includes('å®«ä½')) {
      return 'astrology';
    }
    
    if (lowerQuestion.includes('æ•°å­—') || lowerQuestion.includes('numerology') ||
        lowerQuestion.includes('ç”Ÿå‘½æ•°å­—') || lowerQuestion.includes('æ•°å­—å‘½ç†')) {
      return 'numerology';
    }
    
    return 'general';
  }

  /**
   * è§£æAIå“åº”
   */
  private parseAIResponse(aiResponse: string, originalQuestion: string): Omit<FortuneAnalysisResult, 'processingTime'> {
    try {
      // æå–ä¸»è¦é¢„æµ‹å†…å®¹
      const prediction = this.extractMainContent(aiResponse);
      
      // æå–å»ºè®®å†…å®¹
      const advice = this.extractAdvice(aiResponse);
      
      // æå–å¹¸è¿å…ƒç´ 
      const luckyElements = this.extractLuckyElements(aiResponse);
      
      // è®¡ç®—ç½®ä¿¡åº¦ï¼ˆåŸºäºå“åº”çš„å®Œæ•´æ€§å’Œä¸“ä¸šæ€§ï¼‰
      const confidence = this.calculateConfidence(aiResponse, prediction);

      return {
        success: true,
        prediction,
        advice,
        luckyElements,
        confidence,
        source: 'real-modelscope-ai',
        apiStatus: 'success'
      };
    } catch (error: any) {
      console.error('è§£æAIå“åº”å¤±è´¥:', error.message);
      
      return {
        success: false,
        prediction: aiResponse || 'æ— æ³•è§£æAIå“åº”å†…å®¹',
        advice: 'å»ºè®®ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
        luckyElements: ['é‡‘è‰²', '8', 'ä¸­å¿ƒ'],
        confidence: 0.3,
        source: 'real-modelscope-parse-error',
        apiStatus: 'response-parsing-error'
      };
    }
  }

  /**
   * æå–ä¸»è¦å†…å®¹
   */
  private extractMainContent(text: string): string {
    // æŒ‰è¡Œåˆ†å‰²å¹¶æå–å‰å‡ æ®µæœ‰æ„ä¹‰çš„å†…å®¹
    const lines = text.split('\n').filter(line => line.trim().length > 5);
    
    // æå–å‰3-4æ®µä½œä¸ºä¸»è¦å†…å®¹
    const mainContent = lines.slice(0, 4).join('\n\n');
    
    return mainContent || text.substring(0, 300);
  }

  /**
   * æå–å»ºè®®å†…å®¹
   */
  private extractAdvice(text: string): string {
    const adviceKeywords = ['å»ºè®®', 'æŒ‡å¯¼', 'åº”è¯¥', 'éœ€è¦', 'å¯ä»¥', 'æ¨è', 'Action', 'Tips'];
    const lines = text.split('\n');
    
    for (const line of lines) {
      if (adviceKeywords.some(keyword => line.includes(keyword))) {
        return line.trim();
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ˜ç¡®å»ºè®®ï¼Œæå–æœ€åä¸€æ®µä½œä¸ºå»ºè®®
    const lastMeaningfulLine = lines.filter(line => line.trim().length > 10).pop();
    return lastMeaningfulLine || 'ä¿æŒç§¯æå¿ƒæ€ï¼Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­åŠ›ã€‚';
  }

  /**
   * æå–å¹¸è¿å…ƒç´ 
   */
  private extractLuckyElements(text: string): string[] {
    const elements: string[] = [];
    
    // æå–é¢œè‰²
    const colors = text.match(/(çº¢è‰²|è“è‰²|ç»¿è‰²|é»„è‰²|ç´«è‰²|é‡‘è‰²|é“¶è‰²|é»‘è‰²|ç™½è‰²|æ©™è‰²|ç²‰è‰²|æ£•è‰²)/g);
    if (colors) elements.push(...colors.slice(0, 2));
    
    // æå–æ•°å­—
    const numbers = text.match(/([1-9]|10|11|12|13)/g);
    if (numbers) elements.push(...numbers.slice(0, 2));
    
    // æå–æ–¹å‘
    const directions = text.match(/(ä¸œæ–¹|å—æ–¹|è¥¿æ–¹|åŒ—æ–¹|ä¸œ|å—|è¥¿|åŒ—|ä¸­å¿ƒ)/g);
    if (directions) elements.push(...directions.slice(0, 1));
    
    // å¦‚æœæ²¡æœ‰æå–åˆ°ï¼Œè¿”å›é»˜è®¤å€¼
    if (elements.length === 0) {
      return ['è“è‰²', '7', 'ä¸œæ–¹'];
    }
    
    return [...new Set(elements)]; // å»é‡
  }

  /**
   * è®¡ç®—ç½®ä¿¡åº¦
   */
  private calculateConfidence(aiResponse: string, prediction: string): number {
    let confidence = 0.6; // åŸºç¡€ç½®ä¿¡åº¦
    
    // æ ¹æ®å“åº”é•¿åº¦è°ƒæ•´ç½®ä¿¡åº¦
    if (aiResponse.length > 200) confidence += 0.1;
    if (aiResponse.length > 500) confidence += 0.1;
    if (aiResponse.length > 800) confidence += 0.1;
    
    // æ ¹æ®é¢„æµ‹å†…å®¹çš„å®Œæ•´æ€§è°ƒæ•´ç½®ä¿¡åº¦
    if (prediction.includes('å»ºè®®') || prediction.includes('åˆ†æ')) confidence += 0.1;
    if (prediction.length > 100) confidence += 0.1;
    
    // ç¡®ä¿ç½®ä¿¡åº¦åœ¨åˆç†èŒƒå›´å†…
    return Math.min(Math.max(confidence, 0.3), 0.95);
  }

  /**
   * è·å–å¤‡ç”¨é¢„æµ‹
   */
  private getFallbackPrediction(errorMessage: string): string {
    return `ğŸ¤– AIåˆ†ææš‚æ—¶ä¸å¯ç”¨ (${errorMessage})ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäºè§„åˆ™çš„å¤‡ç”¨å“åº”ã€‚è¯·ç¨åå†è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚`;
  }

  /**
   * å¥åº·æ£€æŸ¥
   */
  async healthCheck(): Promise<{
    healthy: boolean;
    service: string;
    timestamp: string;
    uptime: number;
    apiStatus: string;
  }> {
    const startTime = Date.now();
    
    try {
      // ç®€å•çš„APIè¿é€šæ€§æµ‹è¯•
      const testPrompt = 'ä½ å¥½';
      await this.callModelScopeAPI(testPrompt);
      
      const responseTime = Date.now() - startTime;
      
      return {
        healthy: true,
        service: 'RealModelScopeOnlineService',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        apiStatus: `connected (${responseTime}ms)`
      };
    } catch (error: any) {
      return {
        healthy: false,
        service: 'RealModelScopeOnlineService',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        apiStatus: `disconnected: ${error.message}`
      };
    }
  }

  /**
   * è·å–æœåŠ¡çŠ¶æ€
   */
  async getServiceStatus(): Promise<{
    status: string;
    service: string;
    version: string;
    config: {
      modelId: string;
      baseUrl: string;
      hasApiKey: boolean;
    };
    statistics: {
      totalRequests: number;
      conversationHistory: number;
    };
    capabilities: string[];
  }> {
    return {
      status: 'active',
      service: 'RealModelScopeOnlineService',
      version: '3.0.0',
      config: {
        modelId: this.config.modelId,
        baseUrl: this.config.baseUrl,
        hasApiKey: !!this.config.apiKey
      },
      statistics: {
        totalRequests: this.conversationHistory.length,
        conversationHistory: this.conversationHistory.length
      },
      capabilities: [
        'æ™ºèƒ½ç®—å‘½åˆ†æ',
        'å¤šç±»å‹ç®—å‘½æ”¯æŒ',
        'å®æ—¶APIè°ƒç”¨',
        'å¯¹è¯å†å²è®°å½•',
        'å¥åº·æ£€æŸ¥',
        'é”™è¯¯æ¢å¤'
      ]
    };
  }

  /**
   * è·å–å¯¹è¯å†å²
   */
  getConversationHistory(): Array<{question: string; response: string}> {
    return [...this.conversationHistory];
  }

  /**
   * æ¸…ç©ºå¯¹è¯å†å²
   */
  clearHistory(): void {
    this.conversationHistory = [];
    console.log('ğŸ“ å¯¹è¯å†å²å·²æ¸…ç©º');
  }
}

export default RealModelScopeOnlineService;